#!/bin/sh

date
export PS4='+ $SECONDS + '
set -xue

#############################
# Source shell init, module, and platform 
#############################
source ${USHhafs}/hafs_pre_job.sh.inc
module list

#############################
# Source relevant config files
#   NET, RUN, RUN_GSI, HOMEhafs, WORKhafs, DATA, COM, DATMdir, DOCNdir, STORMID, CASE, ETC.
#############################
source ${HOLDVARS:-storm1.holdvars.txt}

#############################
# Source APRUN, job card info
#############################
source ${USHhafs}/hafs_runcmd.sh.inc

#############################
# Deterministic or ensemble
#############################
if [ "${ENSDA}" != YES ]; then
  export DATA=${WORKhafs}/forecast
else
  export ENSID=${ENSID:-001}
  export DATA=${WORKhafs}/forecast_ens/mem${ENSID}
fi

#############################
# Init DATA location
#############################
export SCRUBDATA=${SCRUBDATA:-YES}
if [ "${SCRUBDATA}" = YES ]; then
  rm -rf $DATA
fi
mkdir -p $DATA
cd $DATA

#############################
# Execute ex-script
#############################
${HOMEhafs}/scripts/exhafs_forecast.sh
status=$?
[[ $status -ne 0 ]] && exit $status

#############################
# Cleanup DATA after run
#############################
export KEEPDATA=${KEEPDATA:-YES}
cd ${WORKhafs}
if [ "${KEEPDATA^^}" != YES ]; then
  rm -rf $DATA
fi

date
